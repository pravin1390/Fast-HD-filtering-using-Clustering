%% Example bilateral filter code

clc;
clear;
close all;

%% input
% [filename, user_canceled] = imgetfile; %% Uncomment this line to choose any image from your system
filename='dome.jpg';
I  =  double(imread(filename));
[m,n,d]=size(I);
sigs=10;
sigr=40;
Iact=I./255;
fast_flag=0;

%% direct bilateral filtering
tic,
Idirectbf=bilateral_filter(I,sigs,sigr);    %exact bilateral
Tdirect=toc;
fprintf('Direct bilateral filter : \n');
fprintf('time for direct bilateral(ms)=%3.0f \n',Tdirect*1000);


%% Proposed filtering

% Done in two steps : Clustering and Filtering

% Clustering
Cluster=15;
tic,
%Bisecting K-means clustering
%Ares=reshape(Iact,m*n,d);
%[Centre,mincentre]=kmeans_recursive(Ares,Cluster);
%Clusterindex=reshape(mincentre,m,n);
%Inbuilt Matlab clustering code     
[Clusterindex,Centre] = rgb2ind(uint8(I),Cluster,'nodither');
Clusterindex=Clusterindex+1;

% Filtering
spatialtype='gaussian';     
convmethod='O1'; % 'matlab' for matlab convolutions and 'O1' for O(1) convolutions
Ikmean=fastKmeansfiltapprox(Iact,sigs,sigr/255,Centre,Clusterindex,spatialtype,convmethod,fast_flag);      % bilateral kmeans
Ikmean=Ikmean.*255;
Ikmean(Ikmean<0)=0;
Ikmean(Ikmean>255)=255;
Tkmeans=toc;
fprintf('Fast bilateral filter by Kmeans complete with %d clusters \n',size(Centre,1));
fprintf('time for fast bilateral(ms)=%3.0f \n',Tkmeans*1000);


%% Detail enhancement
% lamda=1.2;
% alpha=0.6;
% Il=Iact+(lamda.*((Iact-Ikmean).^alpha));
% Il=Il*255;
%figure;
%imshow(uint8(Il));%title('Enhanced image');

%% Accuracy
error2 = reshape(Idirectbf-Ikmean, [d*m*n,1]);
MSE_mcbf2 = sqrt(sum(error2.^2)/(d*m*n));
PSNR2=20*log10(255/(MSE_mcbf2));
fprintf('mean sq error=%f, PSNR = %f db  \n',MSE_mcbf2,PSNR2);

%% Output Images
figure;
imshow(uint8(I));%title('Original image');
figure;
imshow(uint8(Idirectbf));%title('direct bilateral filter');
figure;
imshow(uint8(Ikmean));%title('fast bilateral filter');
